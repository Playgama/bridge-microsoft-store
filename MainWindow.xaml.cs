using Windows.Services.Store; using Microsoft.UI; using Microsoft.UI.Dispatching; using Microsoft.UI.Xaml; using Microsoft.UI.Windowing; using Microsoft.Web.WebView2.Core; using Newtonsoft.Json.Linq; using System; using System.IO; using System.Linq; using System.Threading.Tasks; using Windows.Graphics; using WinRT.Interop;  namespace PlaygamaBridgeMicrosoftStore {     public sealed partial class MainWindow : Window     {         private static class ActionName         {             public const string INITIALIZE = "initialize";             public const string AUTHORIZE_PLAYER = "authorize_player";             public const string SHARE = "share";             public const string INVITE_FRIENDS = "invite_friends";             public const string JOIN_COMMUNITY = "join_community";             public const string CREATE_POST = "create_post";             public const string ADD_TO_HOME_SCREEN = "add_to_home_screen";             public const string ADD_TO_FAVORITES = "add_to_favorites";             public const string RATE = "rate";             public const string LEADERBOARDS_SET_SCORE = "leaderboards_set_score";             public const string LEADERBOARDS_GET_ENTRIES = "leaderboards_get_entries";             public const string LEADERBOARDS_SHOW_NATIVE_POPUP = "leaderboards_show_native_popup";             public const string GET_PURCHASES = "get_purchases";             public const string GET_CATALOG = "get_catalog";             public const string PURCHASE = "purchase";             public const string CONSUME_PURCHASE = "consume_purchase";             public const string GET_REMOTE_CONFIG = "get_remote_config";             public const string GET_STORAGE_DATA = "get_storage_data";             public const string SET_STORAGE_DATA = "set_storage_data";             public const string DELETE_STORAGE_DATA = "delete_storage_data";             public const string CLIPBOARD_WRITE = "clipboard_write";             public const string ADBLOCK_DETECT = "adblock_detect";             public const string SET_INTERSTITIAL_STATE = "set_interstitial_state";             public const string SET_REWARDED_STATE = "set_rewarded_state";             public const string SHOW_INTERSTITIAL = "show_interstitial";             public const string SHOW_REWARDED = "show_rewarded";         }          private readonly StoreContext _store = StoreContext.GetDefault();         private static readonly string[] _durableKinds = new[] { "Durable", "UnmanagedConsumable" };         private static readonly string[] _consumableKinds = new[] { "Consumable" };          public MainWindow()         {             InitializeComponent();             SetInitialSize(1100, 720);             _ = InitializeAsync();         }          private async Task InitializeAsync()         {             await GameWebView.EnsureCoreWebView2Async();             GameWebView.CoreWebView2.WebMessageReceived += CoreWebView2_WebMessageReceived;              var htmlPath = Path.Combine(AppContext.BaseDirectory, "Assets", "game");              GameWebView.CoreWebView2.SetVirtualHostNameToFolderMapping(                 "app.local",                 htmlPath,                 CoreWebView2HostResourceAccessKind.Allow                );              GameWebView.Source = new Uri("https://app.local/index.html");         }          private void CoreWebView2_WebMessageReceived(CoreWebView2 sender, CoreWebView2WebMessageReceivedEventArgs args)         {             var msg = args.TryGetWebMessageAsString();             AppendLog($"Web → Host: {msg}");              JObject? obj = null;             string? action = null;              try             {                 obj = JObject.Parse(msg);                 action = (string?)obj["action"];             }             catch (Exception)             {                 // invalid JSON (or not an object) -> keep action = null             }              AppendLog($"Parsed action: {action ?? "<null>"}");              if (string.IsNullOrWhiteSpace(action))             {                 Reply(sender, $"Host received: {msg}");                 return;             }              switch (action)             {                 case ActionName.INITIALIZE:                     HandleInitialize(sender, obj);                     return;                  case ActionName.GET_PURCHASES:                     _ = HandleGetPurchasesAsync(sender, obj);                     return;                  case ActionName.GET_CATALOG:                     _ = HandleGetCatalogAsync(sender, obj);                     return;                  case ActionName.PURCHASE:                     _ = HandlePurchaseAsync(sender, obj);                     return;                  case ActionName.CONSUME_PURCHASE:                     _ = HandleConsumePurchaseAsync(sender, obj);                     return;                  default:                     HandleUnknownAction(sender, action, obj);                     return;             }         }          private void HandleInitialize(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: initialize");              var response = new JObject             {                 ["action"] = ActionName.INITIALIZE,                 ["success"] = true             };              Reply(sender, response.ToString());         }          private async Task HandleGetCatalogAsync(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: get_catalog");              try             {                 // Returns add-ons associated with the current app (IAPs configured in Partner Center).                 // Note: For test, the app must be associated with Store or running with Store-signed package for real data.                 var result = await _store.GetAssociatedStoreProductsAsync(_durableKinds.Concat(_consumableKinds));                  if (result.ExtendedError is not null && result.ExtendedError.HResult != 0)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_CATALOG,                         ["success"] = false,                         ["error"] = "store_error",                         ["extendedError"] = result.ExtendedError.ToString(),                     }.ToString());                     return;                 }                  var items = new JArray();                 foreach (var kv in result.Products)                 {                     var p = kv.Value;                      items.Add(new JObject                     {                         ["storeId"] = p.StoreId,                         ["productKind"] = p.ProductKind,                         ["title"] = p.Title,                         ["description"] = p.Description,                         ["inAppOfferToken"] = p.InAppOfferToken,                         ["price"] = new JObject                         {                             ["formattedBasePrice"] = p.Price?.FormattedBasePrice,                             ["formattedPrice"] = p.Price?.FormattedPrice,                             ["currencyCode"] = p.Price?.CurrencyCode,                         }                     });                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_CATALOG,                     ["success"] = true,                     ["items"] = items                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_CATALOG,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private async Task HandleGetPurchasesAsync(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: get_purchases");              try             {                 // Returns licenses for the current app + its add-ons.                 var result = await _store.GetAppLicenseAsync();                  if (result is null)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_PURCHASES,                         ["success"] = false,                         ["error"] = "no_license"                     }.ToString());                     return;                 }                  var purchases = new JArray();                  // Add-ons                 foreach (var kv in result.AddOnLicenses)                 {                     var addonStoreId = kv.Key;                     var lic = kv.Value;                      purchases.Add(new JObject                     {                         ["storeId"] = addonStoreId,                         ["isActive"] = lic.IsActive,                         ["expirationDate"] = lic.ExpirationDate                     });                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_PURCHASES,                     ["success"] = true,                     ["purchases"] = purchases                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_PURCHASES,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private async Task HandlePurchaseAsync(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: purchase");              // Expected: { action:"purchase", storeId:"9NBLGGH...." } (or productStoreId)             var storeId = (string?)message?["storeId"] ?? (string?)message?["productStoreId"];              if (string.IsNullOrWhiteSpace(storeId))             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.PURCHASE,                     ["success"] = false,                     ["error"] = "missing_storeId"                 }.ToString());                 return;             }              try             {                 var result = await _store.RequestPurchaseAsync(storeId);                  Reply(sender, new JObject                 {                     ["action"] = ActionName.PURCHASE,                     ["success"] = result.Status == StorePurchaseStatus.Succeeded || result.Status == StorePurchaseStatus.AlreadyPurchased,                     ["status"] = result.Status.ToString(),                     ["extendedError"] = result.ExtendedError is null || result.ExtendedError.HResult == 0 ? null : result.ExtendedError.ToString(),                     ["storeId"] = storeId                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.PURCHASE,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message,                     ["storeId"] = storeId                 }.ToString());             }         }          private async Task HandleConsumePurchaseAsync(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: consume_purchase");              // Expected: { action:"consume_purchase", storeId:"...", quantity:1, trackingId:"guid" }             var storeId = (string?)message?["storeId"] ?? (string?)message?["productStoreId"];             var quantity = (uint?)message?["quantity"] ?? 1u;              var trackingIdString = (string?)message?["trackingId"];             var trackingId = Guid.TryParse(trackingIdString, out var guid) ? guid : Guid.NewGuid();              if (string.IsNullOrWhiteSpace(storeId))             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = false,                     ["error"] = "missing_storeId"                 }.ToString());                 return;             }              try             {                 var result = await _store.ReportConsumableFulfillmentAsync(storeId, quantity, trackingId);                  Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = result.Status == StoreConsumableStatus.Succeeded,                     ["status"] = result.Status.ToString(),                     ["balanceRemaining"] = result.BalanceRemaining,                     ["extendedError"] = result.ExtendedError is null || result.ExtendedError.HResult == 0 ? null : result.ExtendedError.ToString(),                     ["storeId"] = storeId,                     ["trackingId"] = trackingId.ToString()                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message,                     ["storeId"] = storeId                 }.ToString());             }         }          private void HandleUnknownAction(CoreWebView2 sender, string action, JObject? message)         {             AppendLog($"Handler: unknown action '{action}'");              var response = new JObject             {                 ["action"] = action,                 ["success"] = false,                 ["error"] = "unknown_action"             };              Reply(sender, response.ToString());         }          private void Reply(CoreWebView2 sender, string payload)         {             sender.PostWebMessageAsString(payload);             AppendLog($"Host → Web: {payload}");         }          private void SendButton_Click(object sender, RoutedEventArgs e)         {             var msg = MessageTextBox.Text ?? string.Empty;             if (GameWebView.CoreWebView2 is null)             {                 AppendLog("CoreWebView2 not initialized yet.");                 return;             }                 GameWebView.CoreWebView2.PostWebMessageAsString(msg);             AppendLog($"Host → Web: {msg}");         }          private void AppendLog(string text)         {             DispatcherQueue.TryEnqueue(() =>             {                 LogListBox.Items.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {text}");             });         }          private void SetInitialSize(int width, int height)         {             var hwnd = WindowNative.GetWindowHandle(this);             var windowId = Win32Interop.GetWindowIdFromWindow(hwnd);             var appWindow = AppWindow.GetFromWindowId(windowId);              appWindow.Resize(new SizeInt32(width, height));         }     } } 