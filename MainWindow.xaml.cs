using Windows.Storage; using Windows.Services.Store; using Microsoft.UI; using Microsoft.UI.Dispatching; using Microsoft.UI.Xaml; using Microsoft.UI.Xaml.Controls; using Microsoft.UI.Windowing; using Microsoft.Web.WebView2.Core; using Newtonsoft.Json.Linq; using System; using System.Diagnostics; using System.IO; using System.Linq; using System.Threading.Tasks; using Windows.Graphics; using WinRT.Interop; using Windows.System; using Windows.ApplicationModel; using PlaygamaBridgeMicrosoftStore.Server;  namespace PlaygamaBridgeMicrosoftStore {     public sealed partial class MainWindow : Window     {         private const string SaveFileName = "save.json";          // Only persistence helpers; does not change existing handler logic/format validation.         private static async Task<StorageFile> EnsureSaveFileAsync()         {             var folder = ApplicationData.Current.LocalFolder;              var existing = await folder.TryGetItemAsync(SaveFileName).AsTask().ConfigureAwait(false);             if (existing is StorageFile f)                 return f;              var file = await folder.CreateFileAsync(SaveFileName, CreationCollisionOption.OpenIfExists)                 .AsTask().ConfigureAwait(false);              await FileIO.WriteTextAsync(file, "{}", Windows.Storage.Streams.UnicodeEncoding.Utf8);             return file;         }          private static async Task<JObject> ReadSaveRootAsync()         {             var file = await EnsureSaveFileAsync().ConfigureAwait(false);             var text = await FileIO.ReadTextAsync(file, Windows.Storage.Streams.UnicodeEncoding.Utf8)                 .AsTask().ConfigureAwait(false);              if (string.IsNullOrWhiteSpace(text))                 return new JObject();              try             {                 return JObject.Parse(text);             }             catch             {                 // If corrupted, reset to empty object rather than failing storage operations.                 return new JObject();             }         }          private static async Task WriteSaveRootAsync(JObject root)         {             var file = await EnsureSaveFileAsync().ConfigureAwait(false);             await FileIO.WriteTextAsync(                     file,                     root.ToString(Newtonsoft.Json.Formatting.None),                     Windows.Storage.Streams.UnicodeEncoding.Utf8)                 .AsTask().ConfigureAwait(false);         }         private static class ActionName         {             public const string INITIALIZE = "initialize";             public const string AUTHORIZE_PLAYER = "authorize_player";             public const string SHARE = "share";             public const string INVITE_FRIENDS = "invite_friends";             public const string JOIN_COMMUNITY = "join_community";             public const string CREATE_POST = "create_post";             public const string ADD_TO_HOME_SCREEN = "add_to_home_screen";             public const string ADD_TO_FAVORITES = "add_to_favorites";             public const string RATE = "rate";             public const string LEADERBOARDS_SET_SCORE = "leaderboards_set_score";             public const string LEADERBOARDS_GET_ENTRIES = "leaderboards_get_entries";             public const string LEADERBOARDS_SHOW_NATIVE_POPUP = "leaderboards_show_native_popup";             public const string GET_PURCHASES = "get_purchases";             public const string GET_CATALOG = "get_catalog";             public const string PURCHASE = "purchase";             public const string CONSUME_PURCHASE = "consume_purchase";             public const string GET_REMOTE_CONFIG = "get_remote_config";             public const string GET_STORAGE_DATA = "get_storage_data";             public const string SET_STORAGE_DATA = "set_storage_data";             public const string DELETE_STORAGE_DATA = "delete_storage_data";             public const string CLIPBOARD_WRITE = "clipboard_write";             public const string ADBLOCK_DETECT = "adblock_detect";             public const string SET_INTERSTITIAL_STATE = "set_interstitial_state";             public const string SET_REWARDED_STATE = "set_rewarded_state";             public const string SHOW_INTERSTITIAL = "show_interstitial";             public const string SHOW_REWARDED = "show_rewarded";         }          private static class LocalSettingKey         {             public const string LaunchCount = "launchCount";             public const string RateDialogEverShown = "rateDialogEverShown";         }          private const int MinLaunchCountToPrompt = 3;          private readonly StoreContext _store;         private readonly nint _hwnd;         private LocalAssetServer? _assetServer;          public MainWindow()         {             InitializeComponent();              _hwnd = WindowNative.GetWindowHandle(this);              _store = StoreContext.GetDefault();             InitializeWithWindow.Initialize(_store, _hwnd);              SetInitialSize(1100, 720);              _ = InitializeAsync();         }          private static int IncrementLaunchCount()         {             var settings = ApplicationData.Current.LocalSettings;             var current = settings.Values.TryGetValue(LocalSettingKey.LaunchCount, out var v) && v is int i ? i : 0;             var next = current + 1;             settings.Values[LocalSettingKey.LaunchCount] = next;             return next;         }          private static int GetLaunchCount()         {             var settings = ApplicationData.Current.LocalSettings;             return settings.Values.TryGetValue(LocalSettingKey.LaunchCount, out var v) && v is int i ? i : 0;         }          private static bool GetRateDialogEverShown()         {             var settings = ApplicationData.Current.LocalSettings;             return settings.Values.TryGetValue(LocalSettingKey.RateDialogEverShown, out var v) && v is bool b && b;         }          private static void SetRateDialogEverShown()         {             var settings = ApplicationData.Current.LocalSettings;             settings.Values[LocalSettingKey.RateDialogEverShown] = true;         }          private static bool IsEligibleToShowRateDialog(int launchCount)         {             if (GetRateDialogEverShown())             {                 return false;             }              return launchCount >= MinLaunchCountToPrompt;         }          private async Task ShowRatePromptAsync(XamlRoot xamlRoot, int launchCount)         {             var tcs = new TaskCompletionSource(TaskCreationOptions.RunContinuationsAsynchronously);              if (!DispatcherQueue.TryEnqueue(async () =>             {                 try                 {                     SetRateDialogEverShown();                      var pkg = Package.Current;                      var dialog = new ContentDialog                     {                         Title = "Do you like the game?",                         PrimaryButtonText = "😍",                         CloseButtonText = "😒",                         XamlRoot = xamlRoot                     };                      var dialogResult = await dialog.ShowAsync();                      if (dialogResult != ContentDialogResult.Primary)                     {                         tcs.SetResult();                         return;                     }                      // Prefer Store rating prompt only for Store-signed packages.                     if (pkg.SignatureKind != PackageSignatureKind.Store)                     {                         AppendLog($"Skip RequestRateAndReviewAppAsync (SignatureKind={pkg.SignatureKind}). Using Store URI fallback.");                         await LaunchStoreReviewFallbackAsync();                         tcs.SetResult();                         return;                     }                      await _store.RequestRateAndReviewAppAsync();                     tcs.SetResult();                 }                 catch (Exception ex)                 {                     tcs.SetException(ex);                 }             }))             {                 tcs.SetException(new InvalidOperationException("Failed to show rate prompt dialog (DispatcherQueue.TryEnqueue returned false)."));             }              await tcs.Task;         }          private async Task LaunchStoreReviewFallbackAsync()         {             try             {                 var pfn = Package.Current.Id.FamilyName;                 var uri = new Uri($"ms-windows-store://review/?PFN={pfn}");                 _ = await Launcher.LaunchUriAsync(uri);             }             catch (Exception fallbackEx)             {                 AppendLog($"Fallback review launch failed. HResult=0x{fallbackEx.HResult:X8}, Message={fallbackEx.Message}");             }         }          private async Task InitializeAsync()         {             await GameWebView.EnsureCoreWebView2Async();             GameWebView.CoreWebView2.WebMessageReceived += CoreWebView2_WebMessageReceived;              var permissionProbeScript = @"             (function   () {                 try {                     Object.defineProperty(navigator, 'mediaDevices', {                         get() { return undefined; },                         configurable: false                     });                 } catch (e) {                     // fallback                     try { navigator.mediaDevices = undefined; } catch (e2) { }                 }             })();";              await GameWebView.CoreWebView2.AddScriptToExecuteOnDocumentCreatedAsync(permissionProbeScript);              var htmlPath = Path.Combine(AppContext.BaseDirectory, "Assets", "game");              _assetServer = new LocalAssetServer(htmlPath);             _assetServer.Start();              AppendLog($"Local server: {_assetServer.BaseUri}");              GameWebView.Source = new Uri(_assetServer.BaseUri, "index.html");              _ = IncrementLaunchCount();         }          private void CoreWebView2_WebMessageReceived(CoreWebView2 sender, CoreWebView2WebMessageReceivedEventArgs args)         {             var msg = args.TryGetWebMessageAsString();             AppendLog($"Web → Host: {msg}");              string? action = null;             JToken? data = null;              try             {                 var root = JObject.Parse(msg);                 action = (string?)root["action"];                 data = root["data"];             }             catch (Exception)             {                 // invalid JSON             }              AppendLog($"Parsed action: {action ?? "<null>"}");              if (string.IsNullOrWhiteSpace(action))             {                 Reply(sender, $"Host received: {msg}");                 return;             }              switch (action)             {                 case ActionName.INITIALIZE:                     HandleInitialize(sender, data);                     return;                  case ActionName.RATE:                     _ = HandleRateAsync(sender, data);                     return;                  case ActionName.GET_PURCHASES:                     _ = HandleGetPurchasesAsync(sender, data);                     return;                  case ActionName.GET_CATALOG:                     _ = HandleGetCatalogAsync(sender, data);                     return;                  case ActionName.PURCHASE:                     _ = HandlePurchaseAsync(sender, data);                     return;                  case ActionName.CONSUME_PURCHASE:                     _ = HandleConsumePurchaseAsync(sender, data);                     return;                  case ActionName.GET_STORAGE_DATA:                     _ = HandleGetStorageDataAsync(sender, data);                     return;                  case ActionName.SET_STORAGE_DATA:                     _ = HandleSetStorageDataAsync(sender, data);                     return;                  case ActionName.DELETE_STORAGE_DATA:                     _ = HandleDeleteStorageDataAsync(sender, data);                     return;                  default:                     HandleUnknownAction(sender, action);                     return;             }         }          private async Task HandleRateAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: rate");              var launchCount = GetLaunchCount();              if (IsEligibleToShowRateDialog(launchCount))             {                 await ShowRatePromptAsync(GameWebView.XamlRoot, launchCount);             }              Reply(sender, new JObject             {                 ["action"] = ActionName.RATE,                 ["success"] = true,                 ["data"] = data             }.ToString());         }          private void HandleInitialize(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: initialize");              Reply(sender, new JObject             {                 ["action"] = ActionName.INITIALIZE,                 ["success"] = true,                 ["data"] = data             }.ToString());         }          private static string[] ExtractStoreIdsFromData(JToken? data)         {             if (data is not JArray arr)             {                 return Array.Empty<string>();             }              return arr                 .Where(x => x.Type == JTokenType.String)                 .Select(x => (string?)x)                 .Where(x => !string.IsNullOrWhiteSpace(x))                 .Select(x => x!)                 .Distinct(StringComparer.OrdinalIgnoreCase)                 .ToArray();         }          private async Task HandleGetCatalogAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: get_catalog");              var requestedStoreIds = ExtractStoreIdsFromData(data);              try             {                 var kinds = new[] { "Consumable", "Durable", "UnmanagedConsumable" };                  StoreProductQueryResult result = requestedStoreIds.Length > 0                     ? await _store.GetStoreProductsAsync(kinds, requestedStoreIds)                     : await _store.GetAssociatedStoreProductsAsync(kinds);                  if (result.ExtendedError is not null && result.ExtendedError.HResult != 0)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_CATALOG,                         ["success"] = false,                         ["error"] = "store_error",                         ["extendedError"] = result.ExtendedError.ToString(),                     }.ToString());                     return;                 }                  var items = new JArray();                 foreach (var p in result.Products.Values)                 {                     items.Add(new JObject                     {                         ["id"] = p.StoreId,                         ["productKind"] = p.ProductKind,                         ["title"] = p.Title,                         ["description"] = p.Description,                         ["inAppOfferToken"] = p.InAppOfferToken,                         ["hasDigitalDownload"] = p.HasDigitalDownload,                         ["price"] = new JObject                         {                             ["formattedBasePrice"] = p.Price?.FormattedBasePrice,                             ["formattedPrice"] = p.Price?.FormattedPrice,                             ["currencyCode"] = p.Price?.CurrencyCode,                         }                     });                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_CATALOG,                     ["success"] = true,                     ["data"] = items                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_CATALOG,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private async Task HandleGetPurchasesAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: get_purchases");              try             {                 var license = await _store.GetAppLicenseAsync();                 if (license is null)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_PURCHASES,                         ["success"] = false,                         ["error"] = "no_license"                     }.ToString());                     return;                 }                  var purchases = new JArray();                 foreach (var kv in license.AddOnLicenses)                 {                     var storeId = kv.Key;                     var lic = kv.Value;                      purchases.Add(new JObject                     {                         ["id"] = storeId,                         ["isActive"] = lic.IsActive,                         ["expirationDate"] = lic.ExpirationDate                     });                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_PURCHASES,                     ["success"] = true,                     ["data"] = purchases                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_PURCHASES,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private async Task HandlePurchaseAsync(CoreWebView2 sender, JToken? data)         {             var tcs = new TaskCompletionSource(TaskCreationOptions.RunContinuationsAsynchronously);              if (!DispatcherQueue.TryEnqueue(async () =>             {                 try                 {                     AppendLog("Handler: purchase");                      var storeId = data?.Type == JTokenType.String ? (string?)data : null;                      if (string.IsNullOrWhiteSpace(storeId))                     {                         Reply(sender, new JObject                         {                             ["action"] = ActionName.PURCHASE,                             ["success"] = false,                             ["error"] = "missing_storeId"                         }.ToString());                         tcs.SetResult();                         return;                     }                      try                     {                         var result = await _store.RequestPurchaseAsync(storeId);                          Reply(sender, new JObject                         {                             ["action"] = ActionName.PURCHASE,                             ["success"] = result.Status == StorePurchaseStatus.Succeeded ||                                      result.Status == StorePurchaseStatus.AlreadyPurchased,                             ["data"] = new JObject                             {                                 ["id"] = storeId,                                 ["status"] = result.Status.ToString(),                                 ["extendedError"] = result.ExtendedError is null || result.ExtendedError.HResult == 0 ? null : result.ExtendedError.ToString(),                             }                         }.ToString());                     }                     catch (Exception ex)                     {                         Reply(sender, new JObject                         {                             ["action"] = ActionName.PURCHASE,                             ["success"] = false,                             ["error"] = "exception",                             ["message"] = ex.Message,                             ["data"] = storeId                         }.ToString());                     }                      tcs.SetResult();                 }                 catch (Exception ex)                 {                     tcs.SetException(ex);                 }             }))             {                 tcs.SetException(new InvalidOperationException("Failed to marshal purchase to UI thread (DispatcherQueue.TryEnqueue returned false)."));             }              await tcs.Task;         }          private async Task HandleConsumePurchaseAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: consume_purchase");              var storeId = data?.Type == JTokenType.String ? (string?)data : null;              if (string.IsNullOrWhiteSpace(storeId))             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = false,                     ["error"] = "missing_storeId"                 }.ToString());                 return;             }              const uint quantity = 1;             var trackingId = Guid.NewGuid();              try             {                 var result = await _store.ReportConsumableFulfillmentAsync(storeId, quantity, trackingId);                  Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = result.Status == StoreConsumableStatus.Succeeded,                     ["data"] = new JObject                     {                         ["id"] = storeId,                         ["quantity"] = quantity,                         ["status"] = result.Status.ToString(),                         ["balanceRemaining"] = result.BalanceRemaining,                         ["trackingId"] = trackingId.ToString(),                         ["extendedError"] = result.ExtendedError is null || result.ExtendedError.HResult == 0 ? null : result.ExtendedError.ToString(),                     }                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.CONSUME_PURCHASE,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message,                     ["data"] = storeId                 }.ToString());             }         }          // New: storage handlers using ApplicationData.Current.LocalSettings         private async Task HandleGetStorageDataAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: get_storage_data");              try             {                 var root = await ReadSaveRootAsync();                  if (data is null)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_STORAGE_DATA,                         ["success"] = false,                         ["error"] = "missing_data"                     }.ToString());                     return;                 }                  if (data.Type == JTokenType.String)                 {                     var key = (string?)data;                      JToken? value = null;                     if (!string.IsNullOrWhiteSpace(key) && root.TryGetValue(key!, out var v))                     {                         value = v;                     }                      Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_STORAGE_DATA,                         ["success"] = true,                         ["data"] = value                     }.ToString());                     return;                 }                  if (data is JArray arr)                 {                     var results = new JArray();                     foreach (var token in arr)                     {                         if (token.Type != JTokenType.String)                         {                             results.Add(JValue.CreateNull());                             continue;                         }                         var k = (string?)token;                         if (string.IsNullOrWhiteSpace(k)) { results.Add(JValue.CreateNull()); continue; }                         results.Add(root.TryGetValue(k!, out var v) ? (v ?? JValue.CreateNull()) : JValue.CreateNull());                     }                      Reply(sender, new JObject                     {                         ["action"] = ActionName.GET_STORAGE_DATA,                         ["success"] = true,                         ["data"] = results                     }.ToString());                     return;                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_STORAGE_DATA,                     ["success"] = false,                     ["error"] = "invalid_data"                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.GET_STORAGE_DATA,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private async Task HandleSetStorageDataAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: set_storage_data");              try             {                 if (data is not JObject obj)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.SET_STORAGE_DATA,                         ["success"] = false,                         ["error"] = "invalid_data"                     }.ToString());                     return;                 }                  var keyToken = obj["key"];                 var valueToken = obj["value"];                  if (keyToken is null || valueToken is null)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.SET_STORAGE_DATA,                         ["success"] = false,                         ["error"] = "missing_key_or_value"                     }.ToString());                     return;                 }                  static bool TryConvertSettingValue(JToken token, out object? value, out string? error)                 {                     value = null;                     error = null;                      switch (token.Type)                     {                         case JTokenType.String:                             value = (string?)token;                             return true;                          case JTokenType.Boolean:                             value = token.Value<bool>();                             return true;                          case JTokenType.Integer:                             // RoamingSettings supports Int32 (not Int64).                             var l = token.Value<long>();                             if (l < int.MinValue || l > int.MaxValue)                             {                                 error = "integer_out_of_range_int32";                                 return false;                             }                             value = (int)l;                             return true;                          case JTokenType.Float:                             // RoamingSettings supports Double.                             value = token.Value<double>();                             return true;                          case JTokenType.Null:                             value = null;                             return true;                          default:                             error = "unsupported_value_type";                             return false;                     }                 }                  static bool TryGetValidKey(JToken token, out string? key)                 {                     key = null;                     if (token.Type != JTokenType.String) return false;                     key = token.Value<string?>();                     return !string.IsNullOrWhiteSpace(key);                 }                  var root = await ReadSaveRootAsync().ConfigureAwait(false);                  // single key/value                 if (TryGetValidKey(keyToken, out var singleKey))                 {                     if (!TryConvertSettingValue(valueToken, out var value, out var err))                     {                         Reply(sender, new JObject                         {                             ["action"] = ActionName.SET_STORAGE_DATA,                             ["success"] = false,                             ["error"] = err ?? "invalid_value"                         }.ToString());                         return;                     }                      root[singleKey!] = value is null ? JValue.CreateNull() : JToken.FromObject(value);                     await WriteSaveRootAsync(root).ConfigureAwait(false);                      Reply(sender, new JObject                     {                         ["action"] = ActionName.SET_STORAGE_DATA,                         ["success"] = true                     }.ToString());                     return;                 }                  if (keyToken is JArray keysArr && valueToken is JArray valuesArr)                 {                     if (keysArr.Count != valuesArr.Count)                     {                         Reply(sender, new JObject                         {                             ["action"] = ActionName.SET_STORAGE_DATA,                             ["success"] = false,                             ["error"] = "keys_values_length_mismatch"                         }.ToString());                         return;                     }                      for (int i = 0; i < keysArr.Count; i++)                     {                         if (!TryGetValidKey(keysArr[i], out var k))                         {                             Reply(sender, new JObject                             {                                 ["action"] = ActionName.SET_STORAGE_DATA,                                 ["success"] = false,                                 ["error"] = "invalid_key",                                 ["index"] = i                             }.ToString());                             return;                         }                          if (!TryConvertSettingValue(valuesArr[i], out var v, out var err))                         {                             Reply(sender, new JObject                             {                                 ["action"] = ActionName.SET_STORAGE_DATA,                                 ["success"] = false,                                 ["error"] = err ?? "invalid_value",                                 ["index"] = i                             }.ToString());                             return;                         }                          root[k!] = v is null ? JValue.CreateNull() : JToken.FromObject(v);                     }                      await WriteSaveRootAsync(root).ConfigureAwait(false);                      Reply(sender, new JObject                     {                         ["action"] = ActionName.SET_STORAGE_DATA,                         ["success"] = true                     }.ToString());                     return;                 }                  Reply(sender, new JObject                 {                     ["action"] = ActionName.SET_STORAGE_DATA,                     ["success"] = false,                     ["error"] = "unsupported_format"                 }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.SET_STORAGE_DATA,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }         private async Task HandleDeleteStorageDataAsync(CoreWebView2 sender, JToken? data)         {             AppendLog("Handler: delete_storage_data");              try             {                 var root = await ReadSaveRootAsync().ConfigureAwait(false);                  if (data is null)                 {                     Reply(sender, new JObject                     {                         ["action"] = ActionName.DELETE_STORAGE_DATA,                         ["success"] = false,                         ["error"] = "missing_data"                     }.ToString());                     return;                 }                  if (data.Type == JTokenType.String)                 {                     var key = (string?)data;                      if (!string.IsNullOrWhiteSpace(key))                     {                         root.Remove(key!);                         await WriteSaveRootAsync(root).ConfigureAwait(false);                     }                      Reply(sender, new JObject {                          ["action"] = ActionName.DELETE_STORAGE_DATA,                          ["success"] = true,                          ["data"] = new JObject {                              ["key"] = key                          }                      }.ToString());                     return;                 }                  if (data is JArray arr)                 {                     foreach (var token in arr)                     {                         if (token.Type != JTokenType.String) continue;                         var k = (string?)token;                         if (string.IsNullOrWhiteSpace(k)) continue;                         root.Remove(k!);                     }                      await WriteSaveRootAsync(root).ConfigureAwait(false);                      Reply(sender, new JObject { ["action"] = ActionName.DELETE_STORAGE_DATA, ["success"] = true }.ToString());                     return;                 }                  Reply(sender, new JObject { ["action"] = ActionName.DELETE_STORAGE_DATA, ["success"] = false, ["error"] = "invalid_data" }.ToString());             }             catch (Exception ex)             {                 Reply(sender, new JObject                 {                     ["action"] = ActionName.DELETE_STORAGE_DATA,                     ["success"] = false,                     ["error"] = "exception",                     ["message"] = ex.Message                 }.ToString());             }         }          private void HandleUnknownAction(CoreWebView2 sender, string action)         {             AppendLog($"Handler: unknown action '{action}'");              Reply(sender, new JObject             {                 ["action"] = action,                 ["success"] = false,                 ["error"] = "unknown_action"             }.ToString());         }          private void Reply(CoreWebView2 sender, string payload)         {             if (DispatcherQueue is not null && !DispatcherQueue.HasThreadAccess)             {                 _ = DispatcherQueue.TryEnqueue(() =>                 {                     sender.PostWebMessageAsString(payload);                     AppendLog($"Host → Web: {payload}");                 });                 return;             }              sender.PostWebMessageAsString(payload);             AppendLog($"Host → Web: {payload}");         }          private void AppendLog(string text)         {             Debug.WriteLine($"[{DateTime.Now:HH:mm:ss}] {text}");         }          private void SetInitialSize(int width, int height)         {             var hwnd = WindowNative.GetWindowHandle(this);             var windowId = Win32Interop.GetWindowIdFromWindow(hwnd);             var appWindow = AppWindow.GetFromWindowId(windowId);              appWindow.Resize(new SizeInt32(width, height));         }     } } 