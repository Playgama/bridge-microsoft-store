using Microsoft.UI; using Microsoft.UI.Dispatching; using Microsoft.UI.Xaml; using Microsoft.UI.Windowing; using Microsoft.Web.WebView2.Core; using Newtonsoft.Json.Linq; using System; using System.IO; using System.Threading.Tasks; using Windows.Graphics; using WinRT.Interop;  namespace PlaygamaBridgeMicrosoftStore {     public sealed partial class MainWindow : Window     {         private static class ActionName         {             public const string INITIALIZE = "initialize";             public const string AUTHORIZE_PLAYER = "authorize_player";             public const string SHARE = "share";             public const string INVITE_FRIENDS = "invite_friends";             public const string JOIN_COMMUNITY = "join_community";             public const string CREATE_POST = "create_post";             public const string ADD_TO_HOME_SCREEN = "add_to_home_screen";             public const string ADD_TO_FAVORITES = "add_to_favorites";             public const string RATE = "rate";             public const string LEADERBOARDS_SET_SCORE = "leaderboards_set_score";             public const string LEADERBOARDS_GET_ENTRIES = "leaderboards_get_entries";             public const string LEADERBOARDS_SHOW_NATIVE_POPUP = "leaderboards_show_native_popup";             public const string GET_PURCHASES = "get_purchases";             public const string GET_CATALOG = "get_catalog";             public const string PURCHASE = "purchase";             public const string CONSUME_PURCHASE = "consume_purchase";             public const string GET_REMOTE_CONFIG = "get_remote_config";             public const string GET_STORAGE_DATA = "get_storage_data";             public const string SET_STORAGE_DATA = "set_storage_data";             public const string DELETE_STORAGE_DATA = "delete_storage_data";             public const string CLIPBOARD_WRITE = "clipboard_write";             public const string ADBLOCK_DETECT = "adblock_detect";             public const string SET_INTERSTITIAL_STATE = "set_interstitial_state";             public const string SET_REWARDED_STATE = "set_rewarded_state";             public const string SHOW_INTERSTITIAL = "show_interstitial";             public const string SHOW_REWARDED = "show_rewarded";         }          public MainWindow()         {             InitializeComponent();             SetInitialSize(1100, 720);             _ = InitializeAsync();         }          private async Task InitializeAsync()         {             await GameWebView.EnsureCoreWebView2Async();             GameWebView.CoreWebView2.WebMessageReceived += CoreWebView2_WebMessageReceived;              var htmlPath = Path.Combine(AppContext.BaseDirectory, "Assets", "game");              GameWebView.CoreWebView2.SetVirtualHostNameToFolderMapping(                 "app.local",                 htmlPath,                 CoreWebView2HostResourceAccessKind.Allow                );              GameWebView.Source = new Uri("https://app.local/index.html");         }          private void CoreWebView2_WebMessageReceived(CoreWebView2 sender, CoreWebView2WebMessageReceivedEventArgs args)         {             var msg = args.TryGetWebMessageAsString();             AppendLog($"Web → Host: {msg}");              JObject? obj = null;             string? action = null;              try             {                 obj = JObject.Parse(msg);                 action = (string?)obj["action"];             }             catch (Exception)             {                 // invalid JSON (or not an object) -> keep action = null             }              AppendLog($"Parsed action: {action ?? "<null>"}");              if (string.IsNullOrWhiteSpace(action))             {                 Reply(sender, $"Host received: {msg}");                 return;             }              switch (action)             {                 case ActionName.INITIALIZE:                     HandleInitialize(sender, obj);                     return;                  case ActionName.GET_PURCHASES:                     HandleGetPurchases(sender, obj);                     return;                  case ActionName.GET_CATALOG:                     HandleGetCatalog(sender, obj);                     return;                  case ActionName.PURCHASE:                     HandlePurchase(sender, obj);                     return;                  case ActionName.CONSUME_PURCHASE:                     HandleConsumePurchase(sender, obj);                     return;                  default:                     HandleUnknownAction(sender, action, obj);                     return;             }         }          private void HandleInitialize(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: initialize");              // TODO: stub response (can be replaced with real init handshake)             var response = new JObject             {                 ["action"] = ActionName.INITIALIZE,                 ["success"] = true             };              Reply(sender, response.ToString());         }          private void HandleGetPurchases(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: get_purchases");              // TODO: stub             var response = new JObject             {                 ["action"] = ActionName.GET_PURCHASES,                 ["purchases"] = new JArray(),                 ["success"] = true             };              Reply(sender, response.ToString());         }          private void HandleGetCatalog(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: get_catalog");              // TODO: stub             var response = new JObject             {                 ["action"] = ActionName.GET_CATALOG,                 ["items"] = new JArray(),                 ["success"] = true             };              Reply(sender, response.ToString());         }          private void HandlePurchase(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: purchase");              // TODO: stub (echo requested productId for debugging if present)             var response = new JObject             {                 ["action"] = ActionName.PURCHASE,                 ["success"] = false,                 ["error"] = "not_implemented",                 ["productId"] = (string?)message?["productId"]             };              Reply(sender, response.ToString());         }          private void HandleConsumePurchase(CoreWebView2 sender, JObject? message)         {             AppendLog("Handler: consume_purchase");              // TODO: stub             var response = new JObject             {                 ["action"] = ActionName.CONSUME_PURCHASE,                 ["ok"] = false,                 ["error"] = "not_implemented"             };              Reply(sender, response.ToString());         }          private void HandleUnknownAction(CoreWebView2 sender, string action, JObject? message)         {             AppendLog($"Handler: unknown action '{action}'");              var response = new JObject             {                 ["action"] = action,                 ["ok"] = false,                 ["error"] = "unknown_action"             };              Reply(sender, response.ToString());         }          private void Reply(CoreWebView2 sender, string payload)         {             sender.PostWebMessageAsString(payload);             AppendLog($"Host → Web: {payload}");         }          private void SendButton_Click(object sender, RoutedEventArgs e)         {             var msg = MessageTextBox.Text ?? string.Empty;             if (GameWebView.CoreWebView2 is null)             {                 AppendLog("CoreWebView2 not initialized yet.");                 return;             }              GameWebView.CoreWebView2.PostWebMessageAsString(msg);             AppendLog($"Host → Web: {msg}");         }          private void AppendLog(string text)         {             DispatcherQueue.TryEnqueue(() =>             {                 LogListBox.Items.Insert(0, $"[{DateTime.Now:HH:mm:ss}] {text}");             });         }          private void SetInitialSize(int width, int height)         {             var hwnd = WindowNative.GetWindowHandle(this);             var windowId = Win32Interop.GetWindowIdFromWindow(hwnd);             var appWindow = AppWindow.GetFromWindowId(windowId);              appWindow.Resize(new SizeInt32(width, height));         }     } } 